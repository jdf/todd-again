package main

import (
	"fmt"
	"html/template"
	"log"
	"strings"

	gamepb "github.com/jdf/todd-again/game/proto"
	"google.golang.org/protobuf/compiler/protogen"
	"google.golang.org/protobuf/proto"
	"google.golang.org/protobuf/reflect/protoreflect"
	"google.golang.org/protobuf/types/descriptorpb"
)

func main() {
	protogen.Options{}.Run(func(gen *protogen.Plugin) error {
		for _, f := range gen.Files {
			if !f.Generate {
				continue
			}
			generateFile(gen, f)
		}
		return nil
	})
}

type generator struct {
	*protogen.GeneratedFile
	path []string
}

func (g *generator) push(name string) {
	g.path = append(g.path, name)
}

func (g *generator) pop() {
	g.path = g.path[:len(g.path)-1]
}

func (g *generator) Path() string {
	return strings.Join(g.path, ".")
}

func (g *generator) doTemplate(code string, data interface{}) {
	t := template.Must(template.New("code").Parse(code))
	if err := t.Execute(g, data); err != nil {
		log.Fatalf("failed to execute template: %v", err)
	}
}

func (g *generator) emitFloat32(f *protogen.Field) {
	if !f.Desc.HasDefault() {
		panic("all settings must have a default value")
	}
	defaultValue := float32(f.Desc.Default().Float())

	data := map[string]interface{}{
		"name": f.GoName,
		"path": g.Path(),
	}

	opts := f.Desc.Options().(*descriptorpb.FieldOptions)
	data["min"] = 0.5 * defaultValue
	if proto.HasExtension(opts, gamepb.E_Min) {
		data["min"] = proto.GetExtension(opts, gamepb.E_Min).(float32)
	}
	data["max"] = 2 * defaultValue
	if proto.HasExtension(opts, gamepb.E_Max) {
		data["max"] = proto.GetExtension(opts, gamepb.E_Max).(float32)
	}
	code := `
	{
		tmpFloat32 = {{.path}}.Get{{.name}}()
		imgui.SliderFloat("{{.name}}", &tmpFloat32, {{.min}}, {{.max}})
		if {{.path}}.{{.name}} == nil {
			var f float32
			{{.path}}.{{.name}} = &f
		}
		*{{.path}}.{{.name}} = tmpFloat32
	}
`
	g.doTemplate(code, data)
}

func (g *generator) emitColor(f *protogen.Field) {
	data := map[string]interface{}{
		"name": f.GoName,
		"path": g.Path(),
	}
	code := `
	{
		if {{.path}}.{{.name}} == nil {
			{{.path}}.{{.name}} = &Color{
				C: []float32{0,0,0},
			}
		}
		imgui.ColorEdit3("{{.name}}", &tmpColor)
		{{.path}}.{{.name}}.C = tmpColor[:]
	}
`

	g.doTemplate(code, data)
}

func (g *generator) emitMessageField(f *protogen.Field) {
	if f.Message.Desc.FullName() == "game.Color" {
		g.emitColor(f)
		return
	}

	g.P(fmt.Sprintf("if imgui.CollapsingHeader(%q) {", f.GoName))
	g.push(f.GoName)
	for _, f := range f.Message.Fields {
		g.emitFieldRenderingExpression(f)
	}
	g.pop()
	g.P("}")
}

func (g *generator) emitFieldRenderingExpression(f *protogen.Field) {
	switch f.Desc.Kind() {
	case protoreflect.MessageKind:
		g.emitMessageField(f)
	case protoreflect.FloatKind:
		g.emitFloat32(f)
	default:
		log.Fatalf("unsupported field type: %v", f.Desc.Kind())
	}
}

func (g *generator) emitMessageRenderer(m *protogen.Message) {
	g.P(fmt.Sprintf("func Render%s(p *%s) {", m.GoIdent.GoName, g.QualifiedGoIdent(m.GoIdent)))
	g.push("p")
	for _, f := range m.Fields {
		g.emitFieldRenderingExpression(f)
	}
	g.pop()
	g.P("}")
}

type varTypes struct {
	hasFloat32 bool
	hasColor   bool
}

func (v *varTypes) gather(m *protogen.Message) {
	for _, f := range m.Fields {
		switch f.Desc.Kind() {
		case protoreflect.FloatKind:
			v.hasFloat32 = true
		case protoreflect.MessageKind:
			if f.Message.Desc.FullName() == "game.Color" {
				v.hasColor = true
			} else {
				v.gather(f.Message)
			}
		default:
			log.Fatalf("unsupported field type: %v", f.Desc.Kind())
		}
	}
}

func (g *generator) emitVars(file *protogen.File) {
	v := varTypes{}
	for _, m := range file.Messages {
		v.gather(m)
	}
	g.P("var (")
	if v.hasFloat32 {
		g.P("tmpFloat32 float32")
	}
	if v.hasColor {
		g.P("tmpColor = [3]float32{0,0,0}")
	}
	g.P(")")
}

// generateFile generates go source to render a UI for editing the source proto.
func generateFile(gen *protogen.Plugin, file *protogen.File) {
	filename := file.GeneratedFilenamePrefix + "_dear_imgui.go"
	g := &generator{
		gen.NewGeneratedFile(filename, file.GoImportPath),
		[]string{},
	}

	g.P("// Code generated by protoc-gen-imgui. DO NOT EDIT.")
	g.P("package ", file.GoPackageName)

	g.P(`import "github.com/inkyblackness/imgui-go/v4"`)

	g.emitVars(file)

	for _, m := range file.Messages {
		opts := m.Desc.Options().(*descriptorpb.MessageOptions)
		if proto.HasExtension(opts, gamepb.E_TopLevel) &&
			proto.GetExtension(opts, gamepb.E_TopLevel).(bool) {
			log.Printf("top level message: %v", m.GoIdent.GoName)
			g.emitMessageRenderer(m)
		}
	}
	g.Content()
}
